#!/bin/bash

echo "========================================================================"
echo "                  修复重复数字识别问题 - 完整流程"
echo "========================================================================"
echo ""

# 设置Python解释器
PYTHON="/Users/east/CursorProjects/ml_code/iot/bin/python"

echo "修复说明:"
echo "  1. 更新了预处理逻辑，增加基于时间间隔的分割（>500ms）"
echo "  2. 增大了数据生成器中的按键间隔（600-900ms）"
echo "  3. 现在可以正确识别重复数字，如1111、9999"
echo ""

echo "========================================================================"
echo "步骤 1/4: 重新生成训练数据"
echo "========================================================================"
echo ""

echo "200" | $PYTHON generate_synthetic_data_v2.py

if [ $? -ne 0 ]; then
    echo "✗ 训练数据生成失败"
    exit 1
fi

echo ""
echo "========================================================================"
echo "步骤 2/4: 重新训练模型"
echo "========================================================================"
echo ""

$PYTHON run_all.py --data_dir ../sensor_data_synthetic/files --model xgboost

if [ $? -ne 0 ]; then
    echo "✗ 模型训练失败"
    exit 1
fi

echo ""
echo "========================================================================"
echo "步骤 3/4: 重新生成测试数据"
echo "========================================================================"
echo ""

$PYTHON generate_test_data.py

if [ $? -ne 0 ]; then
    echo "✗ 测试数据生成失败"
    exit 1
fi

echo ""
echo "========================================================================"
echo "步骤 4/4: 运行自动测试"
echo "========================================================================"
echo ""

$PYTHON run_auto_test.py

if [ $? -ne 0 ]; then
    echo "✗ 自动测试失败"
    exit 1
fi

echo ""
echo "========================================================================"
echo "✓ 全部完成！"
echo "========================================================================"
echo ""
echo "测试重复数字密码（11111）："
echo ""

# 找到最新的模型
LATEST_MODEL=$(ls -t models/xgboost_*.pkl | head -1)

if [ -f "../test_data/test_password_11111_"*.csv ]; then
    echo "测试密码 11111..."
    $PYTHON 4_predict_password.py \
        --model "$LATEST_MODEL" \
        --data ../test_data/test_password_11111_*.csv \
        --actual 11111
else
    echo "⚠ 测试文件 test_password_11111_*.csv 不存在"
fi

echo ""
echo "========================================================================"
